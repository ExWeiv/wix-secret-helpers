{"version":3,"file":"index.js.map","names":["__importDefault","this","mod","__esModule","default","Object","defineProperty","exports","value","getSecretValue","node_cache_1","require","essentials_1","secrets_1","neverthrow_1","PREFIX","secretsCache","stdTTL","deleteOnExpire","checkperiod","parsedCache","async","secretName","parseJSON","cacheEnabled","Error","response","getSecret","isOk","error","message","cachedSecret","get","returnWithParse","ok","jsonString","has","cachedParsed","parsed","JSON","parse","set","e","String","err","elevatedGetSecretValue","auth","elevate","secrets","wixSecretResponse","fromPromise"],"sources":["lib/index.js"],"sourcesContent":["\"use strict\";\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.getSecretValue = getSecretValue;\nconst node_cache_1 = __importDefault(require(\"@cacheable/node-cache\"));\nconst essentials_1 = require(\"@wix/essentials\");\nconst secrets_1 = require(\"@wix/secrets\");\nconst neverthrow_1 = require(\"neverthrow\");\nconst PREFIX = \"Secret Helpers Error:\";\nconst secretsCache = new node_cache_1.default({ stdTTL: 360, deleteOnExpire: true, checkperiod: 120 });\nconst parsedCache = new node_cache_1.default({ stdTTL: 360, deleteOnExpire: true, checkperiod: 120 });\nasync function getSecretValue(secretName, parseJSON = false, cacheEnabled = true) {\n    if (!secretName) {\n        throw new Error(`${PREFIX} secretName must be a valid string value!`);\n    }\n    if (cacheEnabled === false) {\n        const response = await getSecret(secretName, parseJSON);\n        if (response.isOk()) {\n            return response.value;\n        }\n        else {\n            throw new Error(response.error.message);\n        }\n    }\n    const cachedSecret = secretsCache.get(secretName);\n    if (cachedSecret) {\n        const response = parseJSON ? returnWithParse(cachedSecret, secretName) : (0, neverthrow_1.ok)(cachedSecret);\n        if (response.isOk()) {\n            return response.value;\n        }\n        else {\n            throw new Error(response.error.message);\n        }\n    }\n    else {\n        const response = await getSecret(secretName, parseJSON);\n        if (response.isOk()) {\n            return response.value;\n        }\n        else {\n            throw new Error(response.error.message);\n        }\n    }\n}\nfunction returnWithParse(jsonString, secretName) {\n    try {\n        if (parsedCache.has(secretName)) {\n            const cachedParsed = parsedCache.get(secretName);\n            return (0, neverthrow_1.ok)(cachedParsed);\n        }\n        const parsed = JSON.parse(jsonString);\n        parsedCache.set(secretName, parsed);\n        return (0, neverthrow_1.ok)(parsed);\n    }\n    catch (e) {\n        const error = e instanceof Error ? e : new Error(String(e));\n        return (0, neverthrow_1.err)(error);\n    }\n}\nasync function getSecret(secretName, parseJSON = false) {\n    const elevatedGetSecretValue = essentials_1.auth.elevate(secrets_1.secrets.getSecretValue);\n    const wixSecretResponse = await (0, neverthrow_1.fromPromise)(elevatedGetSecretValue(secretName), (e) => (e instanceof Error ? e : new Error(String(e))));\n    if (wixSecretResponse.isOk()) {\n        const { value } = wixSecretResponse.value;\n        if (!value) {\n            return (0, neverthrow_1.err)(new Error(`${PREFIX} secret value is undefined! Response from Wix: ${value}`));\n        }\n        secretsCache.set(secretName, value);\n        if (parseJSON) {\n            return returnWithParse(value, secretName);\n        }\n        else {\n            return (0, neverthrow_1.ok)(value);\n        }\n    }\n    else {\n        return (0, neverthrow_1.err)(new Error(`${PREFIX} unable to get the secret value from Wix!\\n ${wixSecretResponse.error.message}`));\n    }\n}\nexports.default = { getSecretValue };\n//# sourceMappingURL=index.js.map"],"mappings":"AAAA,aACA,IAAIA,EAAmBC,MAAQA,KAAKD,iBAAoB,SAAUE,GAC9D,OAAQA,GAAOA,EAAIC,WAAcD,EAAM,CAAEE,QAAWF,EACxD,EACAG,OAAOC,eAAeC,QAAS,aAAc,CAAEC,OAAO,IACtDD,QAAQE,eAAiBA,EACzB,MAAMC,EAAeV,EAAgBW,QAAQ,0BACvCC,EAAeD,QAAQ,mBACvBE,EAAYF,QAAQ,gBACpBG,EAAeH,QAAQ,cACvBI,EAAS,wBACTC,EAAe,IAAIN,EAAaN,QAAQ,CAAEa,OAAQ,IAAKC,gBAAgB,EAAMC,YAAa,MAC1FC,EAAc,IAAIV,EAAaN,QAAQ,CAAEa,OAAQ,IAAKC,gBAAgB,EAAMC,YAAa,MAC/FE,eAAeZ,EAAea,EAAYC,GAAY,EAAOC,GAAe,GACxE,IAAKF,EACD,MAAM,IAAIG,MAAM,GAAGV,8CAEvB,IAAqB,IAAjBS,EAAwB,CACxB,MAAME,QAAiBC,EAAUL,EAAYC,GAC7C,GAAIG,EAASE,OACT,OAAOF,EAASlB,MAGhB,MAAM,IAAIiB,MAAMC,EAASG,MAAMC,QAEvC,CACA,MAAMC,EAAef,EAAagB,IAAIV,GACtC,GAAIS,EAAc,CACd,MAAML,EAAWH,EAAYU,EAAgBF,EAAcT,IAAc,EAAIR,EAAaoB,IAAIH,GAC9F,GAAIL,EAASE,OACT,OAAOF,EAASlB,MAGhB,MAAM,IAAIiB,MAAMC,EAASG,MAAMC,QAEvC,CACK,CACD,MAAMJ,QAAiBC,EAAUL,EAAYC,GAC7C,GAAIG,EAASE,OACT,OAAOF,EAASlB,MAGhB,MAAM,IAAIiB,MAAMC,EAASG,MAAMC,QAEvC,CACJ,CACA,SAASG,EAAgBE,EAAYb,GACjC,IACI,GAAIF,EAAYgB,IAAId,GAAa,CAC7B,MAAMe,EAAejB,EAAYY,IAAIV,GACrC,OAAO,EAAIR,EAAaoB,IAAIG,EAChC,CACA,MAAMC,EAASC,KAAKC,MAAML,GAE1B,OADAf,EAAYqB,IAAInB,EAAYgB,IACrB,EAAIxB,EAAaoB,IAAII,EAChC,CACA,MAAOI,GACH,MAAMb,EAAQa,aAAajB,MAAQiB,EAAI,IAAIjB,MAAMkB,OAAOD,IACxD,OAAO,EAAI5B,EAAa8B,KAAKf,EACjC,CACJ,CACAR,eAAeM,EAAUL,EAAYC,GAAY,GAC7C,MAAMsB,EAAyBjC,EAAakC,KAAKC,QAAQlC,EAAUmC,QAAQvC,gBACrEwC,QAA0B,EAAInC,EAAaoC,aAAaL,EAAuBvB,GAAcoB,GAAOA,aAAajB,MAAQiB,EAAI,IAAIjB,MAAMkB,OAAOD,KACpJ,GAAIO,EAAkBrB,OAAQ,CAC1B,MAAMpB,MAAEA,GAAUyC,EAAkBzC,MACpC,OAAKA,GAGLQ,EAAayB,IAAInB,EAAYd,GACzBe,EACOU,EAAgBzB,EAAOc,IAGvB,EAAIR,EAAaoB,IAAI1B,KAPrB,EAAIM,EAAa8B,KAAK,IAAInB,MAAM,GAAGV,mDAAwDP,KAS1G,CAEI,OAAO,EAAIM,EAAa8B,KAAK,IAAInB,MAAM,GAAGV,gDAAqDkC,EAAkBpB,MAAMC,WAE/H,CACAvB,QAAQH,QAAU,CAAEK","ignoreList":[]}